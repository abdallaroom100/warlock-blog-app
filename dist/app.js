"use strict";var ht=Object.create;var ve=Object.defineProperty;var xt=Object.getOwnPropertyDescriptor;var At=Object.getOwnPropertyNames;var Pt=Object.getPrototypeOf,Ut=Object.prototype.hasOwnProperty;var kt=(e,t,o,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of At(t))!Ut.call(e,n)&&n!==o&&ve(e,n,{get:()=>t[n],enumerable:!(s=xt(t,n))||s.enumerable});return e};var $=(e,t,o)=>(o=e!=null?ht(Pt(e)):{},kt(t||!e||!e.__esModule?ve(o,"default",{value:e,enumerable:!0}):o,e));var qe=require("@warlock.js/core");(0,qe.bootstrap)();var be=require("@warlock.js/core");(0,be.displayEnvironmentMode)();var f=$(require("@mongez/config"));var x=require("@mongez/dotenv"),It={appName:(0,x.env)("APP_NAME","Warlock.js"),timezone:(0,x.env)("TIMEZONE","UTC"),baseUrl:(0,x.env)("BASE_URL","http://localhost:3000"),localeCode:(0,x.env)("LOCALE_CODE","en"),localeCodes:["en","ar"]},he=It;var Ue=require("@mongez/dotenv"),ke=require("@warlock.js/auth");var O=require("@warlock.js/auth"),T=require("@warlock.js/cascade"),Pe=require("@warlock.js/core");var Ae=require("@warlock.js/core");function xe(e){return{id:"integer",isActive:"boolean",createdAt:"date",updatedAt:"date",createdBy:w,updatedBy:w,...e}}var w=class extends Ae.Output{output=xe({name:"string",email:"string"})};var i=class extends O.Auth{static collection="users";static output=w;syncWith=[];get userType(){return"user"}defaultValue={isActive:!1};casts={name:"string",isActive:"boolean",image:Pe.uploadable,email:T.castEmail,password:O.castPassword,activationCode:"int",codeExpiresAt:(0,T.expiresAfter)(30,"minutes")};embedded=["id","name","email"]};var Ot={userType:{guest:ke.Guest,user:i},jwt:{secret:(0,Ue.env)("JWT_SECRET")}},Ie=Ot;var C=require("@mongez/dotenv"),h=require("@warlock.js/cache"),Oe=()=>(0,C.env)("CACHE_PREFIX",(0,C.env)("APP_NAME","warlock")),Tt={drivers:{file:h.FileCacheDriver,memory:h.MemoryCacheDriver,redis:h.RedisCacheDriver},default:(0,C.env)("CACHE_DRIVER","memory"),options:{memory:{globalPrefix:Oe},redis:{host:(0,C.env)("REDIS_HOST"),port:(0,C.env)("REDIS_PORT"),url:(0,C.env)("REDIS_URL"),globalPrefix:Oe}}},Te=Tt;var Et={url:"mongodb+srv://warlock:root@warlock.bovpn.mongodb.net/?retryWrites=true&w=majority&appName=warlock",database:"warlock"},Ee=Et;var z=require("@mongez/dotenv"),Ft={port:(0,z.env)("HTTP_PORT",3e3),host:(0,z.env)("HTTP_HOST","localhost"),log:!0,fileUploadLimit:20*1024*1024,rateLimit:{max:260,duration:60*1e3},cors:{origin:"*",methods:["GET","POST","PUT","DELETE","PATCH","OPTIONS"]}},Fe=Ft;var Se=require("@warlock.js/logger"),Y=new Se.ConsoleLog,St={enabled:!0,development:{channels:[Y]},test:{channels:[Y]},production:{channels:[Y]}},Me=St;var _e=require("@warlock.js/core");var g=require("@mongez/dotenv"),Mt={host:(0,g.env)("MAIL_HOST"),username:(0,g.env)("MAIL_USERNAME"),password:(0,g.env)("MAIL_PASSWORD"),port:(0,g.env)("MAIL_PORT"),secure:(0,g.env)("MAIL_SECURE"),from:{name:(0,g.env)("MAIL_FROM_NAME"),address:(0,g.env)("MAIL_FROM_ADDRESS")}},Le=Mt;var Be=require("@warlock.js/core");var Lt={compress:!0,saveTo:e=>e},De=Lt;var r=require("@warlock.js/core"),Dt={stopOnFirstFailure:!0,returnErrorStrategy:"first",responseStatus:400,rules:{unique:r.UniqueRule,requiredIf:r.RequiredIfRule,required:r.RequiredRule,localized:r.LocalizedRule,string:r.StringRule,object:r.ObjectRule,confirmed:r.ConfirmedRule,in:r.InRule,min:r.MinRule,max:r.MaxRule,minLength:r.MinLengthRule,length:r.LengthRule,maxLength:r.MaxLengthRule,email:r.EmailRule,int:r.IntRule,requiredWith:r.RequiredWithRule,requiredWithAll:r.RequiredWithAllRule,float:r.FloatRule,number:r.NumberRule,arrayOf:r.ArrayOfRule,array:r.ArrayRule,bool:r.BooleanRule,boolean:r.BooleanRule,url:r.UrlRule,date:r.DateRule,uploadable:r.UploadableRule,scalar:r.ScalarRule,stringify:r.StringifyRule,file:r.FileRule,image:r.ImageRule},keys:{response:"messages",inputKey:"key",inputError:"error",inputErrors:"errors"}},je=Dt;f.default.set("app",he);f.default.set("auth",Ie);f.default.set("cache",Te);f.default.set("database",Ee);f.default.set("http",Fe);(0,_e.setLogConfigurations)(Me);(0,Be.setMailConfigurations)(Le);f.default.set("uploads",De);f.default.set("validation",je);var jt=f.default.get("app.localeCodes",["en"]);for(let e of jt)e!=="en"&&require(`dayjs/locale/${e}`);var Ge=require("@warlock.js/cascade"),Ne=$(require("express")),He=$(require("cors"));(0,Ge.onceConnected)(()=>{(0,Ne.default)().use((0,He.default)())});var We=require("@mongez/localization");(0,We.groupedTranslations)("auth",{confirmRegistrationSubject:{en:"Activate your account",ar:"\u062A\u0641\u0639\u064A\u0644 \u062D\u0633\u0627\u0628\u0643"},invalidCredentials:{en:"Invalid credentials",ar:"\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u062F\u062E\u0648\u0644 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"},accountNotActivated:{en:"Your account is not activated",ar:"\u062D\u0633\u0627\u0628\u0643 \u063A\u064A\u0631 \u0645\u0641\u0639\u0644"}});var Je=require("@mongez/supportive-is"),Ve=require("@warlock.js/cascade"),K=require("@warlock.js/core");Ve.Model.events().onSaving((e,t)=>{let{user:o}=(0,K.useRequestStore)();o&&(!t&&(0,Je.isEmpty)(e.get("createdBy"))&&e.set("createdBy",o.embeddedData),e.set("updatedBy",o.embeddedData))}).onDeleting(e=>{let{user:t}=(0,K.useRequestStore)();!t||t.userType==="guest"||e.set("deletedBy",t.embeddedData)});var $e=require("@warlock.js/core");function _t(e){if(!e.isJson)return;let t=e.body;if(!t||t.user)return;let o=e.request.user;o&&(t.user=o)}$e.Response.on("sending",_t);var A=require("@warlock.js/cascade");i.events().onSaved(async e=>{let t=await A.database.listCollectionNames();for(let o of t)new A.Aggregate(o).where("createdBy.id",e.id).update({createdBy:e.embeddedData}),new A.Aggregate(o).where("updatedBy.id",e.id).update({updatedBy:e.embeddedData})});var q=require("@warlock.js/core");var P=require("@warlock.js/auth"),v=require("@warlock.js/core"),E=e=>`/admin${e}`;var ze=e=>v.router.group({prefix:"/admin",name:"admin"},e),d=(e,t=[])=>v.router.group({name:"guarded.user",middleware:[(0,P.authMiddleware)("user"),...t]},e),R=e=>v.router.group({name:"guarded.guest",middleware:[(0,P.authMiddleware)()]},e),Ye=e=>ze(()=>{v.router.group({name:"guarded.guest",middleware:[(0,P.authMiddleware)()]},e)}),Ke=e=>ze(()=>{v.router.group({name:"guarded.user",middleware:[(0,P.authMiddleware)("user")]},e)});var Xe=require("@warlock.js/cascade"),l=class extends Xe.Model{static collection="categories";casts={name:"string"}};var Ze=require("@warlock.js/core"),X=async(e,t)=>{let o=e.input("name"),s=await l.create({name:o});return t.success(s.data)};X.validation={rules:{name:["required","string",new Ze.UniqueRule(l,"name").insensitive()]}};var Qe=require("@warlock.js/cascade"),Z=async(e,t)=>t.success();Z.validation={validate:async(e,t)=>{if(!await Qe.query.deleteOne("categories",{id:e.number("id")}))return t.notFound()}};var et=require("@warlock.js/cascade"),tt=async(e,t)=>{let o=await et.query.list("categories");return t.success({categories:o})};var Q=async(e,t)=>t.success({category:e.category});Q.validation={rules:{id:["required"]},validate:async(e,t)=>{let o=await l.find(e.input("id"));if(!o)return t.notFound({error:"category not found"});e.category=o.data}};var ot=require("@warlock.js/cascade"),ee=async(e,t)=>t.success();ee.validation={rules:{name:["required","string"]},validate:async(e,t)=>{if(!await ot.query.update("categories",{id:e.number("id")},{name:e.string("name")}))return t.notFound()}};R(()=>{q.router.prefix("/categories",()=>{q.router.get("/",tt),q.router.get("/:id",Q)})});d(()=>{q.router.post("/categories",X),q.router.put("/categories/:id",ee),q.router.delete("/categories/:id",Z)});var y=require("@warlock.js/core");var U=require("@warlock.js/cascade");var a=class extends U.Model{static collection="posts";casts={content:"string",likes:"array",userId:(0,U.castModel)(i,["name","id"]),comments:"array",category:(0,U.castModel)(l,["id","name"])}};var F=require("@warlock.js/cascade");var u=class extends F.Model{static collection="comments";defaultValue={parentId:null};casts={commentOwner:(0,F.castModel)(i,["id,name"]),content:"string",postId:"number"}};var te=async(e,t)=>{let{id:o,name:s}=e.user.data,n=await u.create({content:e.string("content"),commentOwner:{id:o,name:s},postId:e.number("postId"),parentId:e.number("parentId")||null}),c=e.currentPost;return c.associate("comments",n.only(["commentOwner","content","id","parentId"])),c.save(),t.success()};te.validation={rules:{content:["required","string"],postId:["required"],parentId:["number"]},validate:async(e,t)=>{let o=await a.find(e.input("postId"));if(!o)return t.badRequest({error:"post not found"});let s=e.number("parentId");if(s&&!o.data.comments.some(c=>c.id==s))return t.notFound({error:"parent comment not found"});e.currentPost=o}};var oe=async(e,t)=>{e.post.disassociate("comments",e.comment),e.post.save(),e.comment.destroy(),t.success()};oe.validation={validate:async(e,t)=>{let o=await a.find(e.number("postId"));if(!o)return t.notFound({error:"post not found"});let s=await u.find(e.number("id"));if(!s)return t.notFound({error:"comment not found"});if(s.data.commentOwner.id!==e.user.data.id)return t.badRequest({error:"you can't have access to delete that post"});e.comment=s,e.post=o}};var re=async(e,t)=>{t.success({comment:e.comment})};re.validation={validate:async(e,t)=>{let o=await u.find(e.number("id"));if(!o)return t.notFound({error:"comment not found"});e.comment=o.data}};var rt=require("@warlock.js/cascade");var se=async(e,t)=>{let o=await rt.query.list("comments",{postId:e.number("id")});t.success(o)};se.validation={rules:{postId:["number"]},validate:async(e,t)=>{if(!await a.find(e.number("id")))return t.notFound()}};var st=require("@warlock.js/cascade");var ie=async(e,t)=>{let o=await st.query.list("comments",{parentId:e.number("id"),postId:e.number("postId")});t.success(o)};ie.validation={rules:{postId:["required","number"]},validate:async(e,t)=>{if(!await a.find(e.number("postId")))return t.badRequest({error:"post not found"});if(!await u.find(e.number("id")))return t.notFound()}};var it=require("@warlock.js/cascade");var ne=async(e,t)=>t.success();ne.validation={rules:{content:["required","string"],id:["required"]},validate:async(e,t)=>{let o=await u.find(e.number("id"));if(!o)return t.notFound();if(o.data.commentOwner.id!=e.user.data.id)return t.badRequest("you don't have permission to update this comment");let s=await it.query.update("comments",{id:e.number("id")},{content:e.string("content")});e.comment=s}};y.router.group({prefix:"/comment"},()=>{R(()=>{y.router.post("/replies/:id",ie),y.router.get("/post/:id",se),y.router.get("/:id",re)}),d(()=>{y.router.post("/",te),y.router.put("/:id",ne),y.router.delete("/:id",oe)})});var b=require("@warlock.js/core");var ae=async(e,t)=>{let{id:o,name:s}=e.user.data,n=await a.create({title:e.string("title"),category:e.string("categoryId"),postOwner:{id:o,name:s},likes:[],comments:[]});t.success({post:n.data})};ae.validation={rules:{title:["required","string"],categoryId:["required"]},validate:async(e,t)=>{if(!await l.find(e.number("categoryId")))return t.badRequest({error:"category not found"})}};var nt=require("@warlock.js/cascade"),at=async(e,t)=>{let o=await nt.query.list("posts");t.success({posts:o})};var ue=async(e,t)=>{t.success({post:e.currentPost})};ue.validation={validate:async(e,t)=>{let o=await a.find(e.number("id"));if(!o)return t.notFound();e.currentPost=o}};var me=async(e,t)=>{t.success()};me.validation={validate:async(e,t)=>{let o=e.user.data.id,s=await a.find(e.number("id"));if(!s)return t.badRequest("post not found");let n=new Set(s.data.likes);n.has(o)?n.delete(o):n.add(o),s.data.likes=Array.from(n),s.save()}};var pe=async(e,t)=>{t.success()};pe.validation={rules:{page:["number"],limit:["number"]},validate:async(e,t)=>{let o=e.number("page"),s=e.number("limit");if(o+s){console.log(o,s);let n=await u.aggregate().where("postId","=",e.number("postId")).paginate(e.number("page"),e.number("limit"));console.log(n.documents[0].data)}console.log("page or limit are not exist")}};b.router.group({prefix:"/posts"},()=>{R(()=>{b.router.get("/",at),b.router.get("/:id",ue),b.router.get("/:postId/comments",pe)}),d(()=>{b.router.post("/",ae),b.router.put("/like/:id",me)})});var p=require("@warlock.js/core");d(()=>{p.router.post(["/uploads",E("/uploads")],p.uploadFiles),p.router.post(["/uploads/chunks",E("/uploads/chunks")],p.uploadChunkedFiles),p.router.delete(["/uploads/:hash",E("/uploads/:hash")],p.deleteFile)});p.router.get("/uploads/*",p.getUploadedFile);p.router.get("/uploads/:hash",p.getUploadedFileUsingHash);var m=require("@warlock.js/core");var ut=require("@warlock.js/core");var ce=class extends ut.RepositoryManager{model=i;defaultOptions=this.withDefaultOptions({});filterBy=this.withDefaultFilters({name:"like",isActive:"bool",activationCode:"="})},S=new ce;async function M(e,t){let o=e.user;o.unset("codeExpiresAt","activationCode"),o.save({isActive:!0,activatedAt:new Date});let s=await o.generateAccessToken();return t.success({user:{...await o.toJSON(),accessToken:s,userType:o.userType}})}M.validation={rules:{code:["required"],email:["required","email"]},validate:async(e,t)=>{let o=await S.first({isActive:!1,email:e.input("email"),activationCode:e.int("code")});if(!o)return t.notFound({error:"Invalid activation code"});e.user=o}};async function L(e,t){let o=e.user,s=await o.generateAccessToken();return t.success({user:{...await o.toJSON(),accessToken:s,userType:o.userType}})}L.validation={rules:{password:["required"],email:["required","email"]},validate:async(e,t)=>{let o=await i.attempt(e.only(["email","password"]));if(!o)return t.badRequest({error:"Invalid credentials"});if(!o.get("isActive"))return t.badRequest({error:"Your account is suspended!"});e.user=o}};var mt=require("@mongez/reinforcements"),pt=require("@warlock.js/core");async function D(e,t){return i.create({...e.validated(),activationCode:mt.Random.int(1e5,999999)}),t.success()}D.validation={rules:{name:["required","minLength:2"],email:["required","email",new pt.UniqueRule(i)],password:["required","minLength:8"]}};var dt=require("@mongez/reinforcements");var ct=require("@warlock.js/core");async function de(e){await(0,ct.sendMail)({to:e.get("email"),subject:"Reset Password",html:`
    <h3>Hello, ${e.get("name")}</h3>

    <p>Use the following code to reset your password:</p>

    <p>Please note that this code will expire in 10 minutes.</p>

    <p>Your reset password code is: <strong>${e.get("activationCode")}</strong></p>
    `})}async function k(e,t){return e.user.save({activatedAt:new Date,activationCode:dt.Random.int(1e5,999999)}).then(de),t.success()}k.validation={rules:{email:["required","email"]},validate:async(e,t)=>{let o=await i.first({email:e.input("email")});if(!o)return t.notFound();e.user=o}};var le=require("@warlock.js/core");async function j(e,t){let o=e.user,s=await o.generateAccessToken();return o.save({lastLogin:new Date}),t.success({user:{...await o.toJSON(),accessToken:s,userType:o.userType}})}j.validation={rules:{email:["required","email"],password:["required","string"]},validate:async(e,t)=>{let o=await i.attempt(e.only(["email","password"]));if(!o)return t.badRequest({error:(0,le.t)("auth.invalidCredentials")});if(!o.isActive)return t.forbidden({error:(0,le.t)("auth.accountNotActivated")});e.user=o}};function fe(e,t){return e.user.removeAccessToken(e.accessToken),t.success()}var lt=require("@mongez/reinforcements"),ft=require("@warlock.js/core");async function _(e,t){let o=await i.first({email:e.input("email")});return o?o.get("isActive")?t.badRequest({error:"User already activated"}):(o.save({activationCode:lt.Random.int(1e5,999999),codeExpiresAt:!0}).then(()=>{console.log(o)}),t.success({message:"Activation code sent"})):t.badRequest({error:"User not found"})}_.validation={rules:{email:["required","email",new ft.ExistsRule(i,"email").insensitive()]}};var gt=require("@warlock.js/core");async function I(e,t){let o=e.user;return o.unset("activationCode","codeExpiresAt"),o.save({password:e.input("password")}),e.clearCurrentUser(),t.success()}I.validation={rules:{email:["required","email",new gt.ExistsRule(i,"email").insensitive()],password:["required","confirmed","minLength:8"],code:["required","int","length:6"]},validate:async(e,t)=>{try{let o=await i.first({email:e.input("email"),activationCode:e.int("code")});if(!o)return t.notFound();e.user=o}catch(o){return t.badRequest(o.message)}}};var Rt=require("@warlock.js/core");async function B(e,t){return t.success({})}B.validation={rules:{email:["required","email",new Rt.UniqueRule(i)],code:["required","int","length:6"]}};var G=require("@warlock.js/core");async function N(e,t){return await e.user.save({password:e.input("password")}),t.success()}N.validation={schema:G.v.object({password:G.v.string().minLength(8).required(),confirmPassword:G.v.string().required().matches("password")}),validate:(e,t)=>{if(!e.user.confirmPassword(e.input("currentPassword")))return t.badRequest({error:"Invalid current password"})}};function ge(e,t){let o=e.user;return t.success({user:o})}var Re=require("@warlock.js/core");async function H(e,t){return await e.user.save(e.validated()),t.success()}H.validation={rules:{name:["required","minLength:2"],gender:["in:male,female"],phoneNumber:["required",new Re.UniqueRule(i).exceptCurrentUser()],email:["required","email",new Re.UniqueRule(i).insensitive().exceptCurrentUser()]}};var W=require("@warlock.js/core");var ye=class extends W.Restful{repository=S;validation={create:{rules:{name:["required","min:2"],email:["required","email",new W.UniqueRule(i).exceptCurrentId()]}}}},yt=new ye;var wt=require("@warlock.js/cascade");async function we(e,t){let o=new wt.Aggregate("posts"),s=e.number("id"),n=await u.aggregate().where("commentOwner.id",s).count(),c=await a.aggregate().where("postOwner.id",s).count(),V=await o.where("likes","=",s).count();t.success({totlaComments:n,totalPosts:c,totalLikes:V})}var J=require("@warlock.js/cascade");async function Ce(e,t){let o=async c=>{let V=new J.Aggregate("posts"),vt=await u.aggregate().where("commentOwner.id",c.id).count(),qt=await a.aggregate().where("postOwner.id",c.id).count(),bt=await V.where("likes","=",c.id).count();return{user:{name:c.name,id:c.id},totalContributes:bt+vt+qt}},s=await J.query.list("users"),n=await Promise.all(s.map(async c=>o(c)));n.sort(),t.success({topContributers:n})}Ye(()=>{m.router.post("/login",L),m.router.post("/forget-password",k),m.router.post("/reset-password",I)});Ke(()=>{m.router.restfulResource("/users",yt)});R(()=>{m.router.post("/login",j),m.router.post("/register",D),m.router.post("/register/verify",M),m.router.post("/resend-activation-code",_),m.router.post("/forget-password",k),m.router.post("/forget-password/verify-code",B),m.router.post("/reset-password",I)});d(()=>{m.router.get("/me",ge),m.router.post("/me",H),m.router.post("/logout",fe),m.router.post("/change-password",N)});d(()=>{m.router.get("/user/summary/:id",we),m.router.get("/user/top",Ce)});var Ct=require("@warlock.js/core");(0,Ct.startHttpApplication)();
/*! For license information please see app.js.LEGAL.txt */
