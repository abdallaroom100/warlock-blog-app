"use strict";var qt=Object.create;var ve=Object.defineProperty;var ht=Object.getOwnPropertyDescriptor;var bt=Object.getOwnPropertyNames;var xt=Object.getPrototypeOf,At=Object.prototype.hasOwnProperty;var Pt=(e,t,o,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of bt(t))!At.call(e,n)&&n!==o&&ve(e,n,{get:()=>t[n],enumerable:!(s=ht(t,n))||s.enumerable});return e};var Ut=(e,t,o)=>(o=e!=null?qt(xt(e)):{},Pt(t||!e||!e.__esModule?ve(o,"default",{value:e,enumerable:!0}):o,e));var qe=require("@warlock.js/core");(0,qe.bootstrap)();var he=require("@warlock.js/core");(0,he.displayEnvironmentMode)();var f=Ut(require("@mongez/config"));var A=require("@mongez/dotenv"),kt={appName:(0,A.env)("APP_NAME","Warlock.js"),timezone:(0,A.env)("TIMEZONE","UTC"),baseUrl:(0,A.env)("BASE_URL","http://localhost:3000"),localeCode:(0,A.env)("LOCALE_CODE","en"),localeCodes:["en","ar"]},be=kt;var Ue=require("@mongez/dotenv"),ke=require("@warlock.js/auth");var T=require("@warlock.js/auth"),E=require("@warlock.js/cascade"),Pe=require("@warlock.js/core");var Ae=require("@warlock.js/core");function xe(e){return{id:"integer",isActive:"boolean",createdAt:"date",updatedAt:"date",createdBy:C,updatedBy:C,...e}}var C=class extends Ae.Output{output=xe({name:"string",email:"string"})};var i=class extends T.Auth{static collection="users";static output=C;syncWith=[];get userType(){return"user"}defaultValue={isActive:!1};casts={name:"string",isActive:"boolean",image:Pe.uploadable,email:E.castEmail,password:T.castPassword,activationCode:"int",codeExpiresAt:(0,E.expiresAfter)(30,"minutes")};embedded=["id","name","email"]};var It={userType:{guest:ke.Guest,user:i},jwt:{secret:(0,Ue.env)("JWT_SECRET")}},Ie=It;var v=require("@mongez/dotenv"),x=require("@warlock.js/cache"),Oe=()=>(0,v.env)("CACHE_PREFIX",(0,v.env)("APP_NAME","warlock")),Ot={drivers:{file:x.FileCacheDriver,memory:x.MemoryCacheDriver,redis:x.RedisCacheDriver},default:(0,v.env)("CACHE_DRIVER","memory"),options:{memory:{globalPrefix:Oe},redis:{host:(0,v.env)("REDIS_HOST"),port:(0,v.env)("REDIS_PORT"),url:(0,v.env)("REDIS_URL"),globalPrefix:Oe}}},Te=Ot;var g=require("@mongez/dotenv"),Tt={host:(0,g.env)("DB_HOST","localhost"),port:(0,g.env)("DB_PORT",27017),username:(0,g.env)("DB_USERNAME"),password:(0,g.env)("DB_PASSWORD"),database:(0,g.env)("DB_NAME"),dbAuth:(0,g.env)("DB_AUTH"),url:(0,g.env)("DB_URL")},Ee=Tt;var z=require("@mongez/dotenv"),Et={port:(0,z.env)("HTTP_PORT",3e3),host:(0,z.env)("HTTP_HOST","localhost"),log:!0,fileUploadLimit:20*1024*1024,rateLimit:{max:260,duration:60*1e3},cors:{origin:"*",methods:["GET","POST","PUT","DELETE","PATCH","OPTIONS"]}},De=Et;var Se=require("@warlock.js/logger"),Y=new Se.ConsoleLog,Dt={enabled:!0,development:{channels:[Y]},test:{channels:[Y]},production:{channels:[Y]}},Fe=Dt;var je=require("@warlock.js/core");var R=require("@mongez/dotenv"),St={host:(0,R.env)("MAIL_HOST"),username:(0,R.env)("MAIL_USERNAME"),password:(0,R.env)("MAIL_PASSWORD"),port:(0,R.env)("MAIL_PORT"),secure:(0,R.env)("MAIL_SECURE"),from:{name:(0,R.env)("MAIL_FROM_NAME"),address:(0,R.env)("MAIL_FROM_ADDRESS")}},Me=St;var Be=require("@warlock.js/core");var Ft={compress:!0,saveTo:e=>e},Le=Ft;var r=require("@warlock.js/core"),Mt={stopOnFirstFailure:!0,returnErrorStrategy:"first",responseStatus:400,rules:{unique:r.UniqueRule,requiredIf:r.RequiredIfRule,required:r.RequiredRule,localized:r.LocalizedRule,string:r.StringRule,object:r.ObjectRule,confirmed:r.ConfirmedRule,in:r.InRule,min:r.MinRule,max:r.MaxRule,minLength:r.MinLengthRule,length:r.LengthRule,maxLength:r.MaxLengthRule,email:r.EmailRule,int:r.IntRule,requiredWith:r.RequiredWithRule,requiredWithAll:r.RequiredWithAllRule,float:r.FloatRule,number:r.NumberRule,arrayOf:r.ArrayOfRule,array:r.ArrayRule,bool:r.BooleanRule,boolean:r.BooleanRule,url:r.UrlRule,date:r.DateRule,uploadable:r.UploadableRule,scalar:r.ScalarRule,stringify:r.StringifyRule,file:r.FileRule,image:r.ImageRule},keys:{response:"messages",inputKey:"key",inputError:"error",inputErrors:"errors"}},_e=Mt;f.default.set("app",be);f.default.set("auth",Ie);f.default.set("cache",Te);f.default.set("database",Ee);f.default.set("http",De);(0,je.setLogConfigurations)(Fe);(0,Be.setMailConfigurations)(Me);f.default.set("uploads",Le);f.default.set("validation",_e);var Lt=f.default.get("app.localeCodes",["en"]);for(let e of Lt)e!=="en"&&require(`dayjs/locale/${e}`);var Ne=require("@warlock.js/cascade");(0,Ne.onceConnected)(()=>{});var Ge=require("@mongez/localization");(0,Ge.groupedTranslations)("auth",{confirmRegistrationSubject:{en:"Activate your account",ar:"\u062A\u0641\u0639\u064A\u0644 \u062D\u0633\u0627\u0628\u0643"},invalidCredentials:{en:"Invalid credentials",ar:"\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u062F\u062E\u0648\u0644 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"},accountNotActivated:{en:"Your account is not activated",ar:"\u062D\u0633\u0627\u0628\u0643 \u063A\u064A\u0631 \u0645\u0641\u0639\u0644"}});var He=require("@warlock.js/core");function _t(e){if(!e.isJson)return;let t=e.body;if(!t||t.user)return;let o=e.request.user;o&&(t.user=o)}He.Response.on("sending",_t);var P=require("@warlock.js/cascade");i.events().onSaved(async e=>{let t=await P.database.listCollectionNames();for(let o of t)new P.Aggregate(o).where("createdBy.id",e.id).update({createdBy:e.embeddedData}),new P.Aggregate(o).where("updatedBy.id",e.id).update({updatedBy:e.embeddedData})});var We=require("@mongez/supportive-is"),Je=require("@warlock.js/cascade"),K=require("@warlock.js/core");Je.Model.events().onSaving((e,t)=>{let{user:o}=(0,K.useRequestStore)();o&&(!t&&(0,We.isEmpty)(e.get("createdBy"))&&e.set("createdBy",o.embeddedData),e.set("updatedBy",o.embeddedData))}).onDeleting(e=>{let{user:t}=(0,K.useRequestStore)();!t||t.userType==="guest"||e.set("deletedBy",t.embeddedData)});var h=require("@warlock.js/core");var U=require("@warlock.js/auth"),q=require("@warlock.js/core"),D=e=>`/admin${e}`;var Ve=e=>q.router.group({prefix:"/admin",name:"admin"},e),d=(e,t=[])=>q.router.group({name:"guarded.user",middleware:[(0,U.authMiddleware)("user"),...t]},e),y=e=>q.router.group({name:"guarded.guest",middleware:[(0,U.authMiddleware)()]},e),$e=e=>Ve(()=>{q.router.group({name:"guarded.guest",middleware:[(0,U.authMiddleware)()]},e)}),ze=e=>Ve(()=>{q.router.group({name:"guarded.user",middleware:[(0,U.authMiddleware)("user")]},e)});var Ye=require("@warlock.js/cascade"),l=class extends Ye.Model{static collection="categories";casts={name:"string"}};var Ke=require("@warlock.js/core"),X=async(e,t)=>{let o=e.input("name"),s=await l.create({name:o});return t.success(s.data)};X.validation={rules:{name:["required","string",new Ke.UniqueRule(l,"name").insensitive()]}};var Xe=require("@warlock.js/cascade"),Z=async(e,t)=>t.success();Z.validation={validate:async(e,t)=>{if(!await Xe.query.deleteOne("categories",{id:e.number("id")}))return t.notFound()}};var Ze=require("@warlock.js/cascade"),Qe=async(e,t)=>{let o=await Ze.query.list("categories");return t.success({categories:o})};var Q=async(e,t)=>t.success({category:e.category});Q.validation={rules:{id:["required"]},validate:async(e,t)=>{let o=await l.find(e.input("id"));if(!o)return t.notFound({error:"category not found"});e.category=o.data}};var et=require("@warlock.js/cascade"),ee=async(e,t)=>t.success();ee.validation={rules:{name:["required","string"]},validate:async(e,t)=>{if(!await et.query.update("categories",{id:e.number("id")},{name:e.string("name")}))return t.notFound()}};y(()=>{h.router.prefix("/categories",()=>{h.router.get("/",Qe),h.router.get("/:id",Q)})});d(()=>{h.router.post("/categories",X),h.router.put("/categories/:id",ee),h.router.delete("/categories/:id",Z)});var w=require("@warlock.js/core");var k=require("@warlock.js/cascade");var a=class extends k.Model{static collection="posts";casts={content:"string",likes:"array",userId:(0,k.castModel)(i,["name","id"]),comments:"array",category:(0,k.castModel)(l,["id","name"])}};var S=require("@warlock.js/cascade");var u=class extends S.Model{static collection="comments";defaultValue={parentId:null};casts={commentOwner:(0,S.castModel)(i,["id,name"]),content:"string",postId:"number"}};var te=async(e,t)=>{let{id:o,name:s}=e.user.data,n=await u.create({content:e.string("content"),commentOwner:{id:o,name:s},postId:e.number("postId"),parentId:e.number("parentId")||null}),c=e.currentPost;return c.associate("comments",n.only(["commentOwner","content","id","parentId"])),c.save(),t.success()};te.validation={rules:{content:["required","string"],postId:["required"],parentId:["number"]},validate:async(e,t)=>{let o=await a.find(e.input("postId"));if(!o)return t.badRequest({error:"post not found"});let s=e.number("parentId");if(s&&!o.data.comments.some(c=>c.id==s))return t.notFound({error:"parent comment not found"});e.currentPost=o}};var oe=async(e,t)=>{e.post.disassociate("comments",e.comment),e.post.save(),e.comment.destroy(),t.success()};oe.validation={validate:async(e,t)=>{let o=await a.find(e.number("postId"));if(!o)return t.notFound({error:"post not found"});let s=await u.find(e.number("id"));if(!s)return t.notFound({error:"comment not found"});if(s.data.commentOwner.id!==e.user.data.id)return t.badRequest({error:"you can't have access to delete that post"});e.comment=s,e.post=o}};var re=async(e,t)=>{t.success({comment:e.comment})};re.validation={validate:async(e,t)=>{let o=await u.find(e.number("id"));if(!o)return t.notFound({error:"comment not found"});e.comment=o.data}};var tt=require("@warlock.js/cascade");var se=async(e,t)=>{let o=await tt.query.list("comments",{postId:e.number("id")});t.success(o)};se.validation={rules:{postId:["number"]},validate:async(e,t)=>{if(!await a.find(e.number("id")))return t.notFound()}};var ot=require("@warlock.js/cascade");var ie=async(e,t)=>{let o=await ot.query.list("comments",{parentId:e.number("id"),postId:e.number("postId")});t.success(o)};ie.validation={rules:{postId:["required","number"]},validate:async(e,t)=>{if(!await a.find(e.number("postId")))return t.badRequest({error:"post not found"});if(!await u.find(e.number("id")))return t.notFound()}};var rt=require("@warlock.js/cascade");var ne=async(e,t)=>t.success();ne.validation={rules:{content:["required","string"],id:["required"]},validate:async(e,t)=>{let o=await u.find(e.number("id"));if(!o)return t.notFound();if(o.data.commentOwner.id!=e.user.data.id)return t.badRequest("you don't have permission to update this comment");let s=await rt.query.update("comments",{id:e.number("id")},{content:e.string("content")});e.comment=s}};w.router.group({prefix:"/comment"},()=>{y(()=>{w.router.post("/replies/:id",ie),w.router.get("/post/:id",se),w.router.get("/:id",re)}),d(()=>{w.router.post("/",te),w.router.put("/:id",ne),w.router.delete("/:id",oe)})});var b=require("@warlock.js/core");var ae=async(e,t)=>{let{id:o,name:s}=e.user.data,n=await a.create({title:e.string("title"),category:e.string("categoryId"),postOwner:{id:o,name:s},likes:[],comments:[]});t.success({post:n.data})};ae.validation={rules:{title:["required","string"],categoryId:["required"]},validate:async(e,t)=>{if(!await l.find(e.number("categoryId")))return t.badRequest({error:"category not found"})}};var st=require("@warlock.js/cascade"),it=async(e,t)=>{let o=await st.query.list("posts");t.success({posts:o})};var ue=async(e,t)=>{t.success({post:e.currentPost})};ue.validation={validate:async(e,t)=>{let o=await a.find(e.number("id"));if(!o)return t.notFound();e.currentPost=o}};var me=async(e,t)=>{t.success()};me.validation={validate:async(e,t)=>{let o=e.user.data.id,s=await a.find(e.number("id"));if(!s)return t.badRequest("post not found");let n=new Set(s.data.likes);n.has(o)?n.delete(o):n.add(o),s.data.likes=Array.from(n),s.save()}};var pe=async(e,t)=>{t.success()};pe.validation={rules:{page:["number"],limit:["number"]},validate:async(e,t)=>{let o=e.number("page"),s=e.number("limit");if(o+s){console.log(o,s);let n=await u.aggregate().where("postId","=",e.number("postId")).paginate(e.number("page"),e.number("limit"));console.log(n.documents[0].data)}console.log("page or limit are not exist")}};b.router.group({prefix:"/posts"},()=>{y(()=>{b.router.get("/",it),b.router.get("/:id",ue),b.router.get("/:postId/comments",pe)}),d(()=>{b.router.post("/",ae),b.router.put("/like/:id",me)})});var p=require("@warlock.js/core");d(()=>{p.router.post(["/uploads",D("/uploads")],p.uploadFiles),p.router.post(["/uploads/chunks",D("/uploads/chunks")],p.uploadChunkedFiles),p.router.delete(["/uploads/:hash",D("/uploads/:hash")],p.deleteFile)});p.router.get("/uploads/*",p.getUploadedFile);p.router.get("/uploads/:hash",p.getUploadedFileUsingHash);var m=require("@warlock.js/core");var nt=require("@warlock.js/core");var ce=class extends nt.RepositoryManager{model=i;defaultOptions=this.withDefaultOptions({});filterBy=this.withDefaultFilters({name:"like",isActive:"bool",activationCode:"="})},F=new ce;async function M(e,t){let o=e.user;o.unset("codeExpiresAt","activationCode"),o.save({isActive:!0,activatedAt:new Date});let s=await o.generateAccessToken();return t.success({user:{...await o.toJSON(),accessToken:s,userType:o.userType}})}M.validation={rules:{code:["required"],email:["required","email"]},validate:async(e,t)=>{let o=await F.first({isActive:!1,email:e.input("email"),activationCode:e.int("code")});if(!o)return t.notFound({error:"Invalid activation code"});e.user=o}};async function L(e,t){let o=e.user,s=await o.generateAccessToken();return t.success({user:{...await o.toJSON(),accessToken:s,userType:o.userType}})}L.validation={rules:{password:["required"],email:["required","email"]},validate:async(e,t)=>{let o=await i.attempt(e.only(["email","password"]));if(!o)return t.badRequest({error:"Invalid credentials"});if(!o.get("isActive"))return t.badRequest({error:"Your account is suspended!"});e.user=o}};var at=require("@mongez/reinforcements"),ut=require("@warlock.js/core");async function _(e,t){return i.create({...e.validated(),activationCode:at.Random.int(1e5,999999)}),t.success()}_.validation={rules:{name:["required","minLength:2"],email:["required","email",new ut.UniqueRule(i)],password:["required","minLength:8"]}};var pt=require("@mongez/reinforcements");var mt=require("@warlock.js/core");async function de(e){await(0,mt.sendMail)({to:e.get("email"),subject:"Reset Password",html:`
    <h3>Hello, ${e.get("name")}</h3>

    <p>Use the following code to reset your password:</p>

    <p>Please note that this code will expire in 10 minutes.</p>

    <p>Your reset password code is: <strong>${e.get("activationCode")}</strong></p>
    `})}async function I(e,t){return e.user.save({activatedAt:new Date,activationCode:pt.Random.int(1e5,999999)}).then(de),t.success()}I.validation={rules:{email:["required","email"]},validate:async(e,t)=>{let o=await i.first({email:e.input("email")});if(!o)return t.notFound();e.user=o}};var le=require("@warlock.js/core");async function j(e,t){let o=e.user,s=await o.generateAccessToken();return o.save({lastLogin:new Date}),t.success({user:{...await o.toJSON(),accessToken:s,userType:o.userType}})}j.validation={rules:{email:["required","email"],password:["required","string"]},validate:async(e,t)=>{let o=await i.attempt(e.only(["email","password"]));if(!o)return t.badRequest({error:(0,le.t)("auth.invalidCredentials")});if(!o.isActive)return t.forbidden({error:(0,le.t)("auth.accountNotActivated")});e.user=o}};function fe(e,t){return e.user.removeAccessToken(e.accessToken),t.success()}var ct=require("@mongez/reinforcements"),dt=require("@warlock.js/core");async function B(e,t){let o=await i.first({email:e.input("email")});return o?o.get("isActive")?t.badRequest({error:"User already activated"}):(o.save({activationCode:ct.Random.int(1e5,999999),codeExpiresAt:!0}).then(()=>{console.log(o)}),t.success({message:"Activation code sent"})):t.badRequest({error:"User not found"})}B.validation={rules:{email:["required","email",new dt.ExistsRule(i,"email").insensitive()]}};var lt=require("@warlock.js/core");async function O(e,t){let o=e.user;return o.unset("activationCode","codeExpiresAt"),o.save({password:e.input("password")}),e.clearCurrentUser(),t.success()}O.validation={rules:{email:["required","email",new lt.ExistsRule(i,"email").insensitive()],password:["required","confirmed","minLength:8"],code:["required","int","length:6"]},validate:async(e,t)=>{try{let o=await i.first({email:e.input("email"),activationCode:e.int("code")});if(!o)return t.notFound();e.user=o}catch(o){return t.badRequest(o.message)}}};var ft=require("@warlock.js/core");async function N(e,t){return t.success({})}N.validation={rules:{email:["required","email",new ft.UniqueRule(i)],code:["required","int","length:6"]}};var G=require("@warlock.js/core");async function H(e,t){return await e.user.save({password:e.input("password")}),t.success()}H.validation={schema:G.v.object({password:G.v.string().minLength(8).required(),confirmPassword:G.v.string().required().matches("password")}),validate:(e,t)=>{if(!e.user.confirmPassword(e.input("currentPassword")))return t.badRequest({error:"Invalid current password"})}};function ge(e,t){let o=e.user;return t.success({user:o})}var Re=require("@warlock.js/core");async function W(e,t){return await e.user.save(e.validated()),t.success()}W.validation={rules:{name:["required","minLength:2"],gender:["in:male,female"],phoneNumber:["required",new Re.UniqueRule(i).exceptCurrentUser()],email:["required","email",new Re.UniqueRule(i).insensitive().exceptCurrentUser()]}};var J=require("@warlock.js/core");var ye=class extends J.Restful{repository=F;validation={create:{rules:{name:["required","min:2"],email:["required","email",new J.UniqueRule(i).exceptCurrentId()]}}}},gt=new ye;var Rt=require("@warlock.js/cascade");async function we(e,t){let o=new Rt.Aggregate("posts"),s=e.number("id"),n=await u.aggregate().where("commentOwner.id",s).count(),c=await a.aggregate().where("postOwner.id",s).count(),$=await o.where("likes","=",s).count();t.success({totlaComments:n,totalPosts:c,totalLikes:$})}var V=require("@warlock.js/cascade");async function Ce(e,t){let o=async c=>{let $=new V.Aggregate("posts"),wt=await u.aggregate().where("commentOwner.id",c.id).count(),Ct=await a.aggregate().where("postOwner.id",c.id).count(),vt=await $.where("likes","=",c.id).count();return{user:{name:c.name,id:c.id},totalContributes:vt+wt+Ct}},s=await V.query.list("users"),n=await Promise.all(s.map(async c=>o(c)));n.sort(),t.success({topContributers:n})}$e(()=>{m.router.post("/login",L),m.router.post("/forget-password",I),m.router.post("/reset-password",O)});ze(()=>{m.router.restfulResource("/users",gt)});y(()=>{m.router.post("/login",j),m.router.post("/register",_),m.router.post("/register/verify",M),m.router.post("/resend-activation-code",B),m.router.post("/forget-password",I),m.router.post("/forget-password/verify-code",N),m.router.post("/reset-password",O)});d(()=>{m.router.get("/me",ge),m.router.post("/me",W),m.router.post("/logout",fe),m.router.post("/change-password",H)});d(()=>{m.router.get("/user/summary/:id",we),m.router.get("/user/top",Ce)});var yt=require("@warlock.js/core");(0,yt.startHttpApplication)();
/*! For license information please see app.js.LEGAL.txt */
