"use strict";var vt=Object.create;var Ce=Object.defineProperty;var qt=Object.getOwnPropertyDescriptor;var bt=Object.getOwnPropertyNames;var ht=Object.getPrototypeOf,xt=Object.prototype.hasOwnProperty;var At=(e,t,o,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of bt(t))!xt.call(e,n)&&n!==o&&Ce(e,n,{get:()=>t[n],enumerable:!(s=qt(t,n))||s.enumerable});return e};var Pt=(e,t,o)=>(o=e!=null?vt(ht(e)):{},At(t||!e||!e.__esModule?Ce(o,"default",{value:e,enumerable:!0}):o,e));var ve=require("@warlock.js/core");(0,ve.bootstrap)();var qe=require("@warlock.js/core");(0,qe.displayEnvironmentMode)();var f=Pt(require("@mongez/config"));var x=require("@mongez/dotenv"),Ut={appName:(0,x.env)("APP_NAME","Warlock.js"),timezone:(0,x.env)("TIMEZONE","UTC"),baseUrl:(0,x.env)("BASE_URL","http://localhost:3000"),localeCode:(0,x.env)("LOCALE_CODE","en"),localeCodes:["en","ar"]},be=Ut;var Pe=require("@mongez/dotenv"),Ue=require("@warlock.js/auth");var O=require("@warlock.js/auth"),T=require("@warlock.js/cascade"),Ae=require("@warlock.js/core");var xe=require("@warlock.js/core");function he(e){return{id:"integer",isActive:"boolean",createdAt:"date",updatedAt:"date",createdBy:w,updatedBy:w,...e}}var w=class extends xe.Output{output=he({name:"string",email:"string"})};var i=class extends O.Auth{static collection="users";static output=w;syncWith=[];get userType(){return"user"}defaultValue={isActive:!1};casts={name:"string",isActive:"boolean",image:Ae.uploadable,email:T.castEmail,password:O.castPassword,activationCode:"int",codeExpiresAt:(0,T.expiresAfter)(30,"minutes")};embedded=["id","name","email"]};var kt={userType:{guest:Ue.Guest,user:i},jwt:{secret:(0,Pe.env)("JWT_SECRET")}},ke=kt;var C=require("@mongez/dotenv"),h=require("@warlock.js/cache"),Ie=()=>(0,C.env)("CACHE_PREFIX",(0,C.env)("APP_NAME","warlock")),It={drivers:{file:h.FileCacheDriver,memory:h.MemoryCacheDriver,redis:h.RedisCacheDriver},default:(0,C.env)("CACHE_DRIVER","memory"),options:{memory:{globalPrefix:Ie},redis:{host:(0,C.env)("REDIS_HOST"),port:(0,C.env)("REDIS_PORT"),url:(0,C.env)("REDIS_URL"),globalPrefix:Ie}}},Oe=It;var Ot={url:"mongodb+srv://warlock:root@warlock.bovpn.mongodb.net/?retryWrites=true&w=majority&appName=warlock",database:"warlock"},Te=Ot;var $=require("@mongez/dotenv"),Tt={port:(0,$.env)("HTTP_PORT",3e3),host:(0,$.env)("HTTP_HOST","localhost"),log:!0,fileUploadLimit:20*1024*1024,rateLimit:{max:260,duration:60*1e3},cors:{origin:"*",methods:["GET","POST","PUT","DELETE","PATCH","OPTIONS"]}},Ee=Tt;var Fe=require("@warlock.js/logger"),z=new Fe.ConsoleLog,Et={enabled:!0,development:{channels:[z]},test:{channels:[z]},production:{channels:[z]}},Se=Et;var je=require("@warlock.js/core");var g=require("@mongez/dotenv"),Ft={host:(0,g.env)("MAIL_HOST"),username:(0,g.env)("MAIL_USERNAME"),password:(0,g.env)("MAIL_PASSWORD"),port:(0,g.env)("MAIL_PORT"),secure:(0,g.env)("MAIL_SECURE"),from:{name:(0,g.env)("MAIL_FROM_NAME"),address:(0,g.env)("MAIL_FROM_ADDRESS")}},Me=Ft;var _e=require("@warlock.js/core");var St={compress:!0,saveTo:e=>e},Le=St;var r=require("@warlock.js/core"),Mt={stopOnFirstFailure:!0,returnErrorStrategy:"first",responseStatus:400,rules:{unique:r.UniqueRule,requiredIf:r.RequiredIfRule,required:r.RequiredRule,localized:r.LocalizedRule,string:r.StringRule,object:r.ObjectRule,confirmed:r.ConfirmedRule,in:r.InRule,min:r.MinRule,max:r.MaxRule,minLength:r.MinLengthRule,length:r.LengthRule,maxLength:r.MaxLengthRule,email:r.EmailRule,int:r.IntRule,requiredWith:r.RequiredWithRule,requiredWithAll:r.RequiredWithAllRule,float:r.FloatRule,number:r.NumberRule,arrayOf:r.ArrayOfRule,array:r.ArrayRule,bool:r.BooleanRule,boolean:r.BooleanRule,url:r.UrlRule,date:r.DateRule,uploadable:r.UploadableRule,scalar:r.ScalarRule,stringify:r.StringifyRule,file:r.FileRule,image:r.ImageRule},keys:{response:"messages",inputKey:"key",inputError:"error",inputErrors:"errors"}},De=Mt;f.default.set("app",be);f.default.set("auth",ke);f.default.set("cache",Oe);f.default.set("database",Te);f.default.set("http",Ee);(0,je.setLogConfigurations)(Se);(0,_e.setMailConfigurations)(Me);f.default.set("uploads",Le);f.default.set("validation",De);var Lt=f.default.get("app.localeCodes",["en"]);for(let e of Lt)e!=="en"&&require(`dayjs/locale/${e}`);var Be=require("@warlock.js/cascade");(0,Be.onceConnected)(()=>{});var Ge=require("@mongez/localization");(0,Ge.groupedTranslations)("auth",{confirmRegistrationSubject:{en:"Activate your account",ar:"\u062A\u0641\u0639\u064A\u0644 \u062D\u0633\u0627\u0628\u0643"},invalidCredentials:{en:"Invalid credentials",ar:"\u0628\u064A\u0627\u0646\u0627\u062A \u0627\u0644\u062F\u062E\u0648\u0644 \u063A\u064A\u0631 \u0635\u062D\u064A\u062D\u0629"},accountNotActivated:{en:"Your account is not activated",ar:"\u062D\u0633\u0627\u0628\u0643 \u063A\u064A\u0631 \u0645\u0641\u0639\u0644"}});var Ne=require("@warlock.js/core");function Dt(e){if(!e.isJson)return;let t=e.body;if(!t||t.user)return;let o=e.request.user;o&&(t.user=o)}Ne.Response.on("sending",Dt);var He=require("@mongez/supportive-is"),We=require("@warlock.js/cascade"),Y=require("@warlock.js/core");We.Model.events().onSaving((e,t)=>{let{user:o}=(0,Y.useRequestStore)();o&&(!t&&(0,He.isEmpty)(e.get("createdBy"))&&e.set("createdBy",o.embeddedData),e.set("updatedBy",o.embeddedData))}).onDeleting(e=>{let{user:t}=(0,Y.useRequestStore)();!t||t.userType==="guest"||e.set("deletedBy",t.embeddedData)});var A=require("@warlock.js/cascade");i.events().onSaved(async e=>{let t=await A.database.listCollectionNames();for(let o of t)new A.Aggregate(o).where("createdBy.id",e.id).update({createdBy:e.embeddedData}),new A.Aggregate(o).where("updatedBy.id",e.id).update({updatedBy:e.embeddedData})});var q=require("@warlock.js/core");var P=require("@warlock.js/auth"),v=require("@warlock.js/core"),E=e=>`/admin${e}`;var Je=e=>v.router.group({prefix:"/admin",name:"admin"},e),d=(e,t=[])=>v.router.group({name:"guarded.user",middleware:[(0,P.authMiddleware)("user"),...t]},e),R=e=>v.router.group({name:"guarded.guest",middleware:[(0,P.authMiddleware)()]},e),Ve=e=>Je(()=>{v.router.group({name:"guarded.guest",middleware:[(0,P.authMiddleware)()]},e)}),$e=e=>Je(()=>{v.router.group({name:"guarded.user",middleware:[(0,P.authMiddleware)("user")]},e)});var ze=require("@warlock.js/cascade"),l=class extends ze.Model{static collection="categories";casts={name:"string"}};var Ye=require("@warlock.js/core"),K=async(e,t)=>{let o=e.input("name"),s=await l.create({name:o});return t.success(s.data)};K.validation={rules:{name:["required","string",new Ye.UniqueRule(l,"name").insensitive()]}};var Ke=require("@warlock.js/cascade"),X=async(e,t)=>t.success();X.validation={validate:async(e,t)=>{if(!await Ke.query.deleteOne("categories",{id:e.number("id")}))return t.notFound()}};var Xe=require("@warlock.js/cascade"),Ze=async(e,t)=>{let o=await Xe.query.list("categories");return t.success({categories:o})};var Z=async(e,t)=>t.success({category:e.category});Z.validation={rules:{id:["required"]},validate:async(e,t)=>{let o=await l.find(e.input("id"));if(!o)return t.notFound({error:"category not found"});e.category=o.data}};var Qe=require("@warlock.js/cascade"),Q=async(e,t)=>t.success();Q.validation={rules:{name:["required","string"]},validate:async(e,t)=>{if(!await Qe.query.update("categories",{id:e.number("id")},{name:e.string("name")}))return t.notFound()}};R(()=>{q.router.prefix("/categories",()=>{q.router.get("/",Ze),q.router.get("/:id",Z)})});d(()=>{q.router.post("/categories",K),q.router.put("/categories/:id",Q),q.router.delete("/categories/:id",X)});var y=require("@warlock.js/core");var U=require("@warlock.js/cascade");var a=class extends U.Model{static collection="posts";casts={content:"string",likes:"array",userId:(0,U.castModel)(i,["name","id"]),comments:"array",category:(0,U.castModel)(l,["id","name"])}};var F=require("@warlock.js/cascade");var u=class extends F.Model{static collection="comments";defaultValue={parentId:null};casts={commentOwner:(0,F.castModel)(i,["id,name"]),content:"string",postId:"number"}};var ee=async(e,t)=>{let{id:o,name:s}=e.user.data,n=await u.create({content:e.string("content"),commentOwner:{id:o,name:s},postId:e.number("postId"),parentId:e.number("parentId")||null}),c=e.currentPost;return c.associate("comments",n.only(["commentOwner","content","id","parentId"])),c.save(),t.success()};ee.validation={rules:{content:["required","string"],postId:["required"],parentId:["number"]},validate:async(e,t)=>{let o=await a.find(e.input("postId"));if(!o)return t.badRequest({error:"post not found"});let s=e.number("parentId");if(s&&!o.data.comments.some(c=>c.id==s))return t.notFound({error:"parent comment not found"});e.currentPost=o}};var te=async(e,t)=>{e.post.disassociate("comments",e.comment),e.post.save(),e.comment.destroy(),t.success()};te.validation={validate:async(e,t)=>{let o=await a.find(e.number("postId"));if(!o)return t.notFound({error:"post not found"});let s=await u.find(e.number("id"));if(!s)return t.notFound({error:"comment not found"});if(s.data.commentOwner.id!==e.user.data.id)return t.badRequest({error:"you can't have access to delete that post"});e.comment=s,e.post=o}};var oe=async(e,t)=>{t.success({comment:e.comment})};oe.validation={validate:async(e,t)=>{let o=await u.find(e.number("id"));if(!o)return t.notFound({error:"comment not found"});e.comment=o.data}};var et=require("@warlock.js/cascade");var re=async(e,t)=>{let o=await et.query.list("comments",{postId:e.number("id")});t.success(o)};re.validation={rules:{postId:["number"]},validate:async(e,t)=>{if(!await a.find(e.number("id")))return t.notFound()}};var tt=require("@warlock.js/cascade");var se=async(e,t)=>{let o=await tt.query.list("comments",{parentId:e.number("id"),postId:e.number("postId")});t.success(o)};se.validation={rules:{postId:["required","number"]},validate:async(e,t)=>{if(!await a.find(e.number("postId")))return t.badRequest({error:"post not found"});if(!await u.find(e.number("id")))return t.notFound()}};var ot=require("@warlock.js/cascade");var ie=async(e,t)=>t.success();ie.validation={rules:{content:["required","string"],id:["required"]},validate:async(e,t)=>{let o=await u.find(e.number("id"));if(!o)return t.notFound();if(o.data.commentOwner.id!=e.user.data.id)return t.badRequest("you don't have permission to update this comment");let s=await ot.query.update("comments",{id:e.number("id")},{content:e.string("content")});e.comment=s}};y.router.group({prefix:"/comment"},()=>{R(()=>{y.router.post("/replies/:id",se),y.router.get("/post/:id",re),y.router.get("/:id",oe)}),d(()=>{y.router.post("/",ee),y.router.put("/:id",ie),y.router.delete("/:id",te)})});var b=require("@warlock.js/core");var ne=async(e,t)=>{let{id:o,name:s}=e.user.data,n=await a.create({title:e.string("title"),category:e.string("categoryId"),postOwner:{id:o,name:s},likes:[],comments:[]});t.success({post:n.data})};ne.validation={rules:{title:["required","string"],categoryId:["required"]},validate:async(e,t)=>{if(!await l.find(e.number("categoryId")))return t.badRequest({error:"category not found"})}};var rt=require("@warlock.js/cascade"),st=async(e,t)=>{let o=await rt.query.list("posts");t.success({posts:o})};var ae=async(e,t)=>{t.success({post:e.currentPost})};ae.validation={validate:async(e,t)=>{let o=await a.find(e.number("id"));if(!o)return t.notFound();e.currentPost=o}};var ue=async(e,t)=>{t.success()};ue.validation={validate:async(e,t)=>{let o=e.user.data.id,s=await a.find(e.number("id"));if(!s)return t.badRequest("post not found");let n=new Set(s.data.likes);n.has(o)?n.delete(o):n.add(o),s.data.likes=Array.from(n),s.save()}};var me=async(e,t)=>{t.success()};me.validation={rules:{page:["number"],limit:["number"]},validate:async(e,t)=>{let o=e.number("page"),s=e.number("limit");if(o+s){console.log(o,s);let n=await u.aggregate().where("postId","=",e.number("postId")).paginate(e.number("page"),e.number("limit"));console.log(n.documents[0].data)}console.log("page or limit are not exist")}};b.router.group({prefix:"/posts"},()=>{R(()=>{b.router.get("/",st),b.router.get("/:id",ae),b.router.get("/:postId/comments",me)}),d(()=>{b.router.post("/",ne),b.router.put("/like/:id",ue)})});var p=require("@warlock.js/core");d(()=>{p.router.post(["/uploads",E("/uploads")],p.uploadFiles),p.router.post(["/uploads/chunks",E("/uploads/chunks")],p.uploadChunkedFiles),p.router.delete(["/uploads/:hash",E("/uploads/:hash")],p.deleteFile)});p.router.get("/uploads/*",p.getUploadedFile);p.router.get("/uploads/:hash",p.getUploadedFileUsingHash);var m=require("@warlock.js/core");var it=require("@warlock.js/core");var pe=class extends it.RepositoryManager{model=i;defaultOptions=this.withDefaultOptions({});filterBy=this.withDefaultFilters({name:"like",isActive:"bool",activationCode:"="})},S=new pe;async function M(e,t){let o=e.user;o.unset("codeExpiresAt","activationCode"),o.save({isActive:!0,activatedAt:new Date});let s=await o.generateAccessToken();return t.success({user:{...await o.toJSON(),accessToken:s,userType:o.userType}})}M.validation={rules:{code:["required"],email:["required","email"]},validate:async(e,t)=>{let o=await S.first({isActive:!1,email:e.input("email"),activationCode:e.int("code")});if(!o)return t.notFound({error:"Invalid activation code"});e.user=o}};async function L(e,t){let o=e.user,s=await o.generateAccessToken();return t.success({user:{...await o.toJSON(),accessToken:s,userType:o.userType}})}L.validation={rules:{password:["required"],email:["required","email"]},validate:async(e,t)=>{let o=await i.attempt(e.only(["email","password"]));if(!o)return t.badRequest({error:"Invalid credentials"});if(!o.get("isActive"))return t.badRequest({error:"Your account is suspended!"});e.user=o}};var nt=require("@mongez/reinforcements"),at=require("@warlock.js/core");async function D(e,t){return i.create({...e.validated(),activationCode:nt.Random.int(1e5,999999)}),t.success()}D.validation={rules:{name:["required","minLength:2"],email:["required","email",new at.UniqueRule(i)],password:["required","minLength:8"]}};var mt=require("@mongez/reinforcements");var ut=require("@warlock.js/core");async function ce(e){await(0,ut.sendMail)({to:e.get("email"),subject:"Reset Password",html:`
    <h3>Hello, ${e.get("name")}</h3>

    <p>Use the following code to reset your password:</p>

    <p>Please note that this code will expire in 10 minutes.</p>

    <p>Your reset password code is: <strong>${e.get("activationCode")}</strong></p>
    `})}async function k(e,t){return e.user.save({activatedAt:new Date,activationCode:mt.Random.int(1e5,999999)}).then(ce),t.success()}k.validation={rules:{email:["required","email"]},validate:async(e,t)=>{let o=await i.first({email:e.input("email")});if(!o)return t.notFound();e.user=o}};var de=require("@warlock.js/core");async function j(e,t){let o=e.user,s=await o.generateAccessToken();return o.save({lastLogin:new Date}),t.success({user:{...await o.toJSON(),accessToken:s,userType:o.userType}})}j.validation={rules:{email:["required","email"],password:["required","string"]},validate:async(e,t)=>{let o=await i.attempt(e.only(["email","password"]));if(!o)return t.badRequest({error:(0,de.t)("auth.invalidCredentials")});if(!o.isActive)return t.forbidden({error:(0,de.t)("auth.accountNotActivated")});e.user=o}};function le(e,t){return e.user.removeAccessToken(e.accessToken),t.success()}var pt=require("@mongez/reinforcements"),ct=require("@warlock.js/core");async function _(e,t){let o=await i.first({email:e.input("email")});return o?o.get("isActive")?t.badRequest({error:"User already activated"}):(o.save({activationCode:pt.Random.int(1e5,999999),codeExpiresAt:!0}).then(()=>{console.log(o)}),t.success({message:"Activation code sent"})):t.badRequest({error:"User not found"})}_.validation={rules:{email:["required","email",new ct.ExistsRule(i,"email").insensitive()]}};var dt=require("@warlock.js/core");async function I(e,t){let o=e.user;return o.unset("activationCode","codeExpiresAt"),o.save({password:e.input("password")}),e.clearCurrentUser(),t.success()}I.validation={rules:{email:["required","email",new dt.ExistsRule(i,"email").insensitive()],password:["required","confirmed","minLength:8"],code:["required","int","length:6"]},validate:async(e,t)=>{try{let o=await i.first({email:e.input("email"),activationCode:e.int("code")});if(!o)return t.notFound();e.user=o}catch(o){return t.badRequest(o.message)}}};var lt=require("@warlock.js/core");async function B(e,t){return t.success({})}B.validation={rules:{email:["required","email",new lt.UniqueRule(i)],code:["required","int","length:6"]}};var G=require("@warlock.js/core");async function N(e,t){return await e.user.save({password:e.input("password")}),t.success()}N.validation={schema:G.v.object({password:G.v.string().minLength(8).required(),confirmPassword:G.v.string().required().matches("password")}),validate:(e,t)=>{if(!e.user.confirmPassword(e.input("currentPassword")))return t.badRequest({error:"Invalid current password"})}};function fe(e,t){let o=e.user;return t.success({user:o})}var ge=require("@warlock.js/core");async function H(e,t){return await e.user.save(e.validated()),t.success()}H.validation={rules:{name:["required","minLength:2"],gender:["in:male,female"],phoneNumber:["required",new ge.UniqueRule(i).exceptCurrentUser()],email:["required","email",new ge.UniqueRule(i).insensitive().exceptCurrentUser()]}};var W=require("@warlock.js/core");var Re=class extends W.Restful{repository=S;validation={create:{rules:{name:["required","min:2"],email:["required","email",new W.UniqueRule(i).exceptCurrentId()]}}}},ft=new Re;var gt=require("@warlock.js/cascade");async function ye(e,t){let o=new gt.Aggregate("posts"),s=e.number("id"),n=await u.aggregate().where("commentOwner.id",s).count(),c=await a.aggregate().where("postOwner.id",s).count(),V=await o.where("likes","=",s).count();t.success({totlaComments:n,totalPosts:c,totalLikes:V})}var J=require("@warlock.js/cascade");async function we(e,t){let o=async c=>{let V=new J.Aggregate("posts"),yt=await u.aggregate().where("commentOwner.id",c.id).count(),wt=await a.aggregate().where("postOwner.id",c.id).count(),Ct=await V.where("likes","=",c.id).count();return{user:{name:c.name,id:c.id},totalContributes:Ct+yt+wt}},s=await J.query.list("users"),n=await Promise.all(s.map(async c=>o(c)));n.sort(),t.success({topContributers:n})}Ve(()=>{m.router.post("/login",L),m.router.post("/forget-password",k),m.router.post("/reset-password",I)});$e(()=>{m.router.restfulResource("/users",ft)});R(()=>{m.router.post("/login",j),m.router.post("/register",D),m.router.post("/register/verify",M),m.router.post("/resend-activation-code",_),m.router.post("/forget-password",k),m.router.post("/forget-password/verify-code",B),m.router.post("/reset-password",I)});d(()=>{m.router.get("/me",fe),m.router.post("/me",H),m.router.post("/logout",le),m.router.post("/change-password",N)});d(()=>{m.router.get("/user/summary/:id",ye),m.router.get("/user/top",we)});var Rt=require("@warlock.js/core");(0,Rt.startHttpApplication)();
/*! For license information please see app.js.LEGAL.txt */
